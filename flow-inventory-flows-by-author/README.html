<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Inventory Flows By Creator | PnP Samples </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Inventory Flows By Creator | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Inventory Flows By Creator | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/siddharth-vaghasia/script-samples/blob/main/scripts/flow-inventory-flows-by-author/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="inventory-flows-by-creator">Inventory Flows By Creator</h1>

<h2 id="summary">Summary</h2>
<p>The <a href="https://admin.flow.microsoft.com/">Power Automate Admin Center</a> provides a list of the Flows in your tenant, but there is no way to easily export Flows from the Flow admin center for governance activities. This script retrieves Flows from the Default Environment and maps creator information from Azure AD to list Flows by owner, state and trigger type.</p>
<p>The <code>bash</code> version of this script uses an external file to process owner mapping. This is provided in the jq tab and should be saved to the same folder as the bash script and named
<code>marge.jq</code>.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_cli-m365-ps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_cli-m365-ps" data-tab="cli-m365-ps" tabindex="0" aria-selected="true">CLI for Microsoft 365 with PowerShell</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_m365cli-bash" role="tab" aria-controls="tabpanel_CeZOj-G++Q_m365cli-bash" data-tab="m365cli-bash" tabindex="-1">CLI for Microsoft 365 with Bash</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_m365cli-jq" role="tab" aria-controls="tabpanel_CeZOj-G++Q_m365cli-jq" data-tab="m365cli-jq" tabindex="-1">jq</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_cli-m365-ps" role="tabpanel" data-tab="cli-m365-ps"><button class="article-clipboard" title="Copy to clipboard" data-toggle="tooltip" data-placement="top" data-clipboard-target="section[id^='tabpanel'][data-tab='cli-m365-ps'] pre">
    <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
    <span class="article-clipboard__message done">Copied</span>
</button>

<pre><code class="lang-powershell">#!/usr/local/bin/pwsh -File

$DIR = Split-Path $script:MyInvocation.MyCommand.Path
$TMP_DIR = &quot;./tmp&quot;
$TMP_FLOWS = &quot;$TMP_DIR/flows.json&quot;
$FLOWSCSV = &quot;flows.csv&quot;

function CleanDistFolder {
    # Remove the dist folder as needed
    if (Test-Path -Path &quot;$TMP_DIR&quot; -PathType Container) {
        Remove-Item -Path &quot;$TMP_DIR&quot; -Recurse -Force -Confirm:$false -ErrorAction SilentlyContinue
    }
}

$CURRENT_USER = $(m365 status).Split(':')[1]
Write-Host &quot;Logged in as $CURRENT_USER&quot;

try {
    if (-not (Test-Path -Path &quot;$TMP_DIR&quot; -PathType Container)) {
        Write-Host &quot; Creating $TMP_DIR folder...&quot;
        New-Item -ItemType Directory -Path &quot;$TMP_DIR&quot;
    }

    #Step 1 - Get the default environment
    Write-Host &quot;Querying for default Flow environment...&quot;
    $flowEnvironments = m365 flow environment list --output json | ConvertFrom-Json
    $defaultEnvironment = $flowEnvironments[0].name
    Write-Host &quot;Found default environment $defaultEnvironment, querying Flows...&quot;

    # Step 2 - Get all of the flows using the cli and write flows json to a tmp file 
    # Use a JMESPath query to filter the size of the file. See https://github.com/pnp/cli-microsoft365/issues/1266
    m365 flow list --environment $defaultEnvironment `
        --query '[].{name: name, displayName: properties.displayName,owner: properties.creator.userId, state: properties.state, created: properties.createdTime, lastModified: properties.lastModifiedTime, trigger: properties.definitionSummary.triggers[0].swaggerOperationId,  triggerType: properties.definitionSummary.triggers[0].type }' --asAdmin --output json |
        Out-File &quot;$TMP_FLOWS&quot; -Encoding ASCII
    $flows = Get-Content &quot;$TMP_FLOWS&quot; | ConvertFrom-Json

    #Step 3 - Get a unique list of the flow owners from the tmp file
    Write-Host &quot;Flows found, searching for owner values...&quot;
    $uniqueOwners = $flows.owner | Sort-Object | Get-Unique
    Write-Host &quot;There are $($uniqueOwners.Count) unique Flows owners.&quot;
    Write-Host &quot;Building owner information mappings...&quot;

    #Step 4 - map properties.creator.userId's to {name, email} mapping hashtable
    Write-Host &quot;Querying graph for userids...&quot;
    $userMap = @{}
    $uniqueOwners | ForEach-Object {
        Write-Host &quot;Querying graph for userid $_...&quot;
        m365 aad user get --id $_ --output json  | ConvertFrom-Json
    } | ForEach-Object {
        $userMap.Add($_.id, @{
                upn = $_.userPrincipalName
                displayName = $_.displayName
                mail = $_.mail
            }
        )
    }
    # And add the Owner information to each flow entry to get owner name and email  
    Write-Host &quot;Mapping owner information...&quot;
    $flows | ForEach-Object {
         $_ | Add-Member -MemberType NoteProperty -Name &quot;upn&quot; -Value  $userMap[$_.owner].upn
         $_ | Add-Member -MemberType NoteProperty -Name &quot;ownerName&quot; -Value  $userMap[$_.owner].displayName
         $_ | Add-Member -MemberType NoteProperty -Name &quot;ownerMail&quot; -Value  $userMap[$_.owner].mail
     }

    #Step 5 - Create a CSV file with header row, flow information and owner email
    $flows | Export-Csv -Path &quot;$FLOWSCSV&quot; -NoTypeInformation

}
finally {
    CleanDistFolder
}

# if we are on macOS try opening the file with Excel
if ($IsMacOS) {
    $answer = Read-Host -Prompt &quot;Open CSV file in Excel? (y/n)&quot;
    switch ($answer)
     {
       y {
            open -a &quot;/Applications/Microsoft Excel.app&quot; &quot;$DIR/$FLOWSCSV&quot;
        }
       Default {
           Write-Host &quot;Open $DIR/$FLOWSCSV to review report.&quot;
        }
     }
}
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>CLI for Microsoft 365</strong> to learn more at: <a href="https://aka.ms/cli-m365">https://aka.ms/cli-m365</a></p>
</div>
</section>
<section id="tabpanel_CeZOj-G++Q_m365cli-bash" role="tabpanel" data-tab="m365cli-bash" aria-hidden="true" hidden="hidden"><button class="article-clipboard" title="Copy to clipboard" data-toggle="tooltip" data-placement="top" data-clipboard-target="section[id^='tabpanel'][data-tab='m365cli-bash'] pre">
    <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
    <span class="article-clipboard__message done">Copied</span>
</button>

<pre><code class="lang-bash">#!/usr/bin/env bash
set -e

DIR=&quot;$( cd &quot;$( dirname &quot;${BASH_SOURCE[0]}&quot; )&quot; &gt;/dev/null &amp;&amp; pwd )&quot;
TMP_ENVIRONMENTS=./tmp/environments.json
TMP_FLOWS=./tmp/flows.json
TMP_OWNERS=./tmp/owners.json
TMP_MAPPEDFLOWS=./tmp/mappedFlows.json
FLOWSCSV=flows.csv
JQ_MERGE_FILE=merge.jq

function cleanup {
    #clean up the tmp files
    rm -rf tmp
    echo &quot;Cleaned tmp folder...&quot;
}
# Configure trap to call finish whenever EXIT is called to ensure cleanup of tmp
trap cleanup EXIT

CURRENT_USER=$(m365 status --output json | jq '.connectedAs')
echo &quot;Logged in as $CURRENT_USER&quot;

if [[ ! -z tmp ]]; then
    echo &quot;Creating temporary folder for file manipulation...&quot;
    mkdir tmp
fi

#Step 1 - Get the default environment
echo &quot;Querying for default Flow environment...&quot;
DEFAULT_ENVIRONMENT=$(m365 flow environment list --output json | jq -r '.[] | select(.name | contains(&quot;'&quot;Default&quot;'&quot;)) | .name')
echo &quot;Found default environment $DEFAULT_ENVIRONMENT, querying Flows...&quot;

#Step 2 - Get all of the flows using the cli and write flows json to a tmp file
#See https://github.com/pnp/cli-microsoft365/issues/1266 for temp file usage reason
m365 flow list --environment $DEFAULT_ENVIRONMENT --asAdmin --output json &gt; $TMP_FLOWS

#Step 3 - Get a unique list of the flow owners from the tmp file
echo &quot;Flows found, searching for owner values...&quot;
uniqueOwners=$(cat $TMP_FLOWS | jq -r 'map({userId: .properties.creator.userId}) | unique | .[] | .userId') 

#Get the owner count and loop to call Microsoft Graph and build owner mapping file  
ownerCount=$(cat $TMP_FLOWS | jq -r 'map({userId: .properties.creator.userId}) | unique | length') 

echo &quot;There are $ownerCount unique Flows owners.&quot;
echo &quot;Building owner information json mapping file...&quot;
echo &quot;[&quot; &gt; $TMP_OWNERS  
i=0
for ownerId in $uniqueOwners; do
    echo &quot;Querying graph for userid $ownerId...&quot;
    echo $(m365 aad user get --id $ownerId --output json) &gt;&gt; $TMP_OWNERS
    if [[ $i -lt $ownerCount-1 ]]; then
        echo &quot;,&quot; &gt;&gt; $TMP_OWNERS
    fi
    i=$(expr $i + 1)  
done
echo &quot;]&quot; &gt;&gt; $TMP_OWNERS  

#Step 4 - Use a jq module file to create a map of the creator.usedId's to {name, email}
echo &quot;Mapping owners information...&quot;
jq -n --argfile flows $TMP_FLOWS --argfile owners $TMP_OWNERS -f $JQ_MERGE_FILE &gt;&gt; $TMP_MAPPEDFLOWS

#Step 5 - Create a CSV file with header row, flow information and owner email
echo &quot;Building CSV file...&quot;
jq -r '[&quot;FlowID&quot;, &quot;DisplayName&quot;, &quot;State&quot;, &quot;Created&quot;, &quot;LastModified&quot;, &quot;Owner&quot;, &quot;OwnerName&quot;, &quot;OwnerMail&quot;, &quot;Upn&quot;, &quot;Trigger&quot;, &quot;TriggerType&quot;], (.[] | [.name, .properties.displayName, .properties.state, .properties.createdTime, .properties.lastModifiedTime, .properties.creator.userId, .properties.creator.displayName, .properties.creator.mail, .properties.creator.userPrincipalName, .properties.definitionSummary.triggers[0].swaggerOperationId, .properties.definitionSummary.triggers[0].type]) | @csv' $TMP_MAPPEDFLOWS &gt; $FLOWSCSV

# if we are on macOS try opening the file with Excel
if [[ &quot;$OSTYPE&quot; == &quot;darwin&quot;* ]]; then
    echo &quot;Open CSV file in Excel? (y/n)?&quot;
    read answer
    if [ &quot;$answer&quot; != &quot;${answer#[Yy]}&quot; ] ;then
        open -a /Applications/Microsoft\ Excel.app $DIR/$FLOWSCSV
    else
        echo &quot;Open $DIR/file.csv to review report.&quot;
    fi
fi
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>CLI for Microsoft 365</strong> to learn more at: <a href="https://aka.ms/cli-m365">https://aka.ms/cli-m365</a></p>
</div>
</section>
<section id="tabpanel_CeZOj-G++Q_m365cli-jq" role="tabpanel" data-tab="m365cli-jq" aria-hidden="true" hidden="hidden"><button class="article-clipboard" title="Copy to clipboard" data-toggle="tooltip" data-placement="top" data-clipboard-target="section[id^='tabpanel'][data-tab='m365cli-jq'] pre">
    <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
    <span class="article-clipboard__message done">Copied</span>
</button>

<pre><code class="lang-bash"># Create a dictionary based on the $owner.id property from the owners array parameter
($owners | map(select(.id != null)) | map( {(.id): {displayName, userPrincipalName, mail}}) | add) as $dict
# Output each flow, append owner information from each entry using flow creator.userId property as the key
| $flows |.[].properties.creator |= . + $dict[.userId]
</code></pre>
</section>
</div>
<h2 id="source-credit">Source Credit</h2>
<p>Sample first appeared on <a href="https://pnp.github.io/cli-microsoft365/sample-scripts/flow/inventory-flows-by-author/">Inventory Flows By Creator | CLI for Microsoft 365</a></p>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pete Skelly</td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://pnptelemetry.azurewebsites.net/script-samples/scripts/flow-inventory-flows-by-author" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>